<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Comptabilit√© - Factures et Journal</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
    body { font-family: Arial; background-color: #e0f0ff; padding: 20px; }
    input, select, button { padding: 8px; }
    button { border: none; border-radius: 4px; cursor: pointer; color: #fff; }
    .btn-green { background-color: #28a745; }
    .btn-blue { background-color: #007bff; }
    .btn-red { background-color: #dc3545; }
    .btn-yellow { background-color: #ffc107; color: #000; }
    .tab-btn { background-color: #007acc; padding: 10px 20px; margin: 5px; border-radius: 6px; color: #fff; cursor: pointer; }
    .tab-btn.active { background-color: #005b99; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .form-container {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 10px 20px;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 600px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #d0e8ff; }
    tr.validated { background-color: #c2f0c2; }
</style>
</head>
<body>

<h1>Gestion Comptable</h1>

<div>
    <span class="tab-btn active" onclick="switchTab('factures')">üßæ Liste des factures</span>
    <span class="tab-btn" onclick="switchTab('journal')">üìò Journal comptable</span>
</div>

<!-- ============================ LISTE DES FACTURES ============================ -->
<div id="factures" class="tab-content active">
    <div class="form-container" id="form-container">
        <label>Journal :</label>
        <select id="journal-achat" onchange="afficherChamps()">
            <option value="">-- S√©lectionner --</option>
            <option value="Achats">Achats</option>
            <option value="Ventes">Ventes</option>
            <option value="Banque">Banque</option>
            <option value="Caisse">Caisse</option>
            <option value="OD">OD</option>
        </select>
        <div id="champs-supplementaires"></div>
    </div>

    <div style="margin-top:10px;">
        <button class="btn-green" onclick="enregistrerAchat()">Enregistrer</button>
        <button class="btn-yellow" onclick="exporterExcel()">Exporter (.xlsx)</button>
        <input type="file" id="import-file" accept=".xlsx" onchange="importerExcel(event)" style="display:none;">
        <button class="btn-blue" onclick="document.getElementById('import-file').click()">Importer (.xlsx)</button>
    </div>

    <div style="margin-top:20px;">
        <label>Filtrer par journal :</label>
        <select id="filtre-journal" onchange="filtrerFactures()">
            <option value="">Tous</option>
            <option value="Achats">Achats</option>
            <option value="Ventes">Ventes</option>
            <option value="Banque">Banque</option>
            <option value="Caisse">Caisse</option>
            <option value="OD">OD</option>
        </select>

        <label>Recherche :</label>
        <input type="text" id="recherche-facture" onkeyup="filtrerFactures()" placeholder="Rechercher...">
    </div>

   <table id="table-achats">
  <thead>
    <tr>
      <th>N¬∞ Pi√®ce</th>
      <th>Journal</th> 
      <th>Date</th>    
      <th>Fournisseur / Client</th>
      <th class="col-facture">Num√©ro de facture</th>
      <th>Compte Comptable</th>
      <th>Montant HT</th>
      <th>TVA</th>
      <th>TTC</th>
      <th>Actions</th>     
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<!-- ============================ JOURNAL COMPTABLE ============================ -->
<div id="journal" class="tab-content">
    <div style="margin-top:20px;">
        <label>Filtrer par compte/libell√© :</label>
        <input type="text" id="recherche-journal" onkeyup="filtrerJournal()" placeholder="Recherche...">
    </div>

    <table id="table-ecritures">
        <thead>
            <tr>
                <th>N¬∞ Pi√®ce</th>
                <th>Journal</th>
                <th>Date</th>
                <th>Fournisseur / Client</th>
                <th>Num√©ro de facture</th>
                <th>Compte Comptable</th>
                <th>D√©bit</th>
                <th>Cr√©dit</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- ============================ SCRIPT ============================ -->
<script>
function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
}

function afficherChamps() {
    const journal = document.getElementById("journal-achat").value;
    const zone = document.getElementById("champs-supplementaires");
    zone.innerHTML = "";
    let html = `<label>Date :</label><input type="date" id="date-achat">`;

    if (journal === "Achats" || journal === "Ventes") {
        html += `
            <label>Fournisseur / Client :</label><input type="text" id="fournisseur-achat">
            <label>Compte Comptable :</label><input list="plan-comptable" id="compte-comptable">
            <datalist id="plan-comptable"> 
                 <option value="111."> Capital social ou personnel</option>
                 <option value="1111."> Capital social</option>
                 <option value="1112."> Fonds de dotation</option>
                 <option value="1117."> Capital personnel</option>

</datalist>
            <label>Num√©ro de facture :</label><input type="text" id="num-facture" placeholder="Num√©ro de facture">
            <label>Montant HT :</label><input type="number" id="ht-achat">
            <label>TVA :</label>
            <select id="tva-achat">
                <option value="">-- Choisir --</option>
                <option value="10">10%</option>
                <option value="20">20%</option>
            </select>`;
    } else {
        html += `
            <label>Compte Comptable :</label><input list="plan-comptable" id="compte-comptable">
 <datalist id="plan-comptable"> 
                 <option value="111."> Capital social ou personnel</option>
                 <option value="1111."> Capital social</option>
                 <option value="1112."> Fonds de dotation</option>
                 <option value="1117."> Capital personnel</option>

</datalist>
            <label>Montant HT :</label><input type="number" id="ht-achat">`;
    }
    zone.innerHTML = html;
}

let numeroChrono = 1;

function enregistrerAchat() {
    const journal = document.getElementById("journal-achat").value;
    const date = document.getElementById("date-achat")?.value || "";
    const fournisseur = document.getElementById("fournisseur-achat")?.value || "-";
    const numFacture = document.getElementById("num-facture")?.value || "";
    const compte = document.getElementById("compte-comptable")?.value || "-";
    const ht = parseFloat(document.getElementById("ht-achat")?.value) || 0;
    const tauxTVA = parseFloat(document.getElementById("tva-achat")?.value) || 0;
    const tva = ht * (tauxTVA / 100);
    const ttc = ht + tva;

    if (!journal || !date || !ht) {
        alert("Merci de remplir les champs obligatoires.");
        return;
sauvegarderDonnees();
    }

    const numPiece = "P" + String(numeroChrono).padStart(4, "0");
    numeroChrono++;

    const tb = document.querySelector("#table-achats tbody");
    const row = tb.insertRow();

    row.insertCell().innerText = numPiece;
    row.insertCell().innerText = journal;
    row.insertCell().innerText = date;
    row.insertCell().innerText = fournisseur;
    row.insertCell().innerText = (journal === "Achats" || journal === "Ventes") ? numFacture : "-";
    row.insertCell().innerText = compte;
    row.insertCell().innerText = ht.toFixed(2);
    row.insertCell().innerText = tauxTVA ? tauxTVA + "%" : "-";
    row.insertCell().innerText = ttc.toFixed(2);

    const cellAct = row.insertCell();
    cellAct.innerHTML = `
        <button class="btn-blue" onclick="modifierFacture(this)">‚úèÔ∏è</button>
        <button class="btn-red" onclick="supprimerFacture(this)">üóëÔ∏è</button>
        <button class="btn-yellow" onclick="validerFacture(this)">‚úîÔ∏è</button>
    `;
}

function validerFacture(btn) {
    const tr = btn.closest("tr");
    tr.classList.add("validated");
    tr.querySelectorAll("button").forEach(b => b.disabled = true);

    const numPiece = tr.cells[0].innerText;
    const journal = tr.cells[1].innerText;
    const date = tr.cells[2].innerText;
    const fournisseur = tr.cells[3].innerText;
    const numFacture = tr.cells[4].innerText;
    const compte = tr.cells[5].innerText;
    const ht = parseFloat(tr.cells[6].innerText);
    const tva = (tr.cells[7].innerText.includes("%")) ? (Math.abs(ht) * parseFloat(tr.cells[7].innerText) / 100) : 0;
    const ttc = Math.abs(ht) + tva;

    let lignes = [];

    // ‚úÖ structure classique selon le journal
    if (journal === "Achats") {
        lignes = [
            { compte: "4411", debit: "", credit: ttc.toFixed(2) },
            { compte: compte, debit: Math.abs(ht).toFixed(2), credit: "" },
            { compte: "3455", debit: tva.toFixed(2), credit: "" }
        ];
    } else if (journal === "Ventes") {
        lignes = [
            { compte: "3421", debit: ttc.toFixed(2), credit: "" },
            { compte: "4455", debit: "", credit: tva.toFixed(2) },
            { compte: compte, debit: "", credit: Math.abs(ht).toFixed(2) }
        ];
    } else if (journal === "Banque") {
        lignes = [
            { compte: compte, debit: Math.abs(ht).toFixed(2), credit: "" },
            { compte: "5141", debit: "", credit: Math.abs(ht).toFixed(2) }
        ];
    } else if (journal === "Caisse") {
        lignes = [
            { compte: compte, debit: Math.abs(ht).toFixed(2), credit: "" },
            { compte: "5161", debit: "", credit: Math.abs(ht).toFixed(2) }
        ];
    } else if (journal === "OD") {
        lignes = [
            { compte: compte, debit: Math.abs(ht).toFixed(2), credit: "" },
            { compte: "Contrepartie", debit: "", credit: Math.abs(ht).toFixed(2) }
        ];
    }

    // ‚úÖ condition d'inversion si montant HT est n√©gatif
    if (ht < 0) {
        lignes = lignes.map(l => ({
            compte: l.compte,
            debit: l.credit,
            credit: l.debit
        }));
    }

    // insertion dans le journal
    const tE = document.querySelector("#table-ecritures tbody");
    lignes.forEach(l => {
        const r = tE.insertRow();
        r.insertCell().innerText = numPiece;
        r.insertCell().innerText = journal;
        r.insertCell().innerText = date;
        r.insertCell().innerText = fournisseur;
        r.insertCell().innerText = numFacture;
        r.insertCell().innerText = l.compte;
        r.insertCell().innerText = l.debit;
        r.insertCell().innerText = l.credit;
    });
sauvegarderDonnees();
}

function filtrerJournal(){
    const r=document.getElementById("recherche-journal").value.toLowerCase();
    document.querySelectorAll("#table-ecritures tbody tr").forEach(tr=>{
        tr.style.display=tr.innerText.toLowerCase().includes(r)?"":"none";
    });
}
function filtrerFactures() {
    const filtre = document.getElementById("filtre-journal").value;
    const recherche = document.getElementById("recherche-facture").value.toLowerCase();
    document.querySelectorAll("#table-achats tbody tr").forEach(tr=>{
        const txt = tr.innerText.toLowerCase();
        const journalCell = tr.cells[1] ? tr.cells[1].innerText : "";
        const matchesJournal = (!filtre) || (journalCell === filtre);
        tr.style.display = (matchesJournal && txt.includes(recherche)) ? "" : "none";
    });
}

function filtrerEcritures() {
    const recherche = document.getElementById("recherche-journal").value.toLowerCase();
    const tbody = document.querySelector("#table-ecritures tbody");
    Array.from(tbody.rows).forEach(r => {
        const texte = r.cells[1].innerText.toLowerCase() + " " + r.cells[2].innerText.toLowerCase();
        r.style.display = texte.includes(recherche) ? "" : "none";
    });
}

function supprimerFacture(btn) {
    const tr = btn.closest("tr");
    tr.remove();
    sauvegarderDonnees();
}
// ============================ SAUVEGARDE LOCALE ============================

// Sauvegarde toutes les donn√©es du tableau dans le LocalStorage
function sauvegarderDonnees() {
    const factures = [];
    document.querySelectorAll("#table-achats tbody tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        factures.push({
            numPiece: tds[0].innerText,
            journal: tds[1].innerText,
            date: tds[2].innerText,
            fournisseur: tds[3].innerText,
            numFacture: tds[4].innerText,
            compte: tds[5].innerText,
            ht: tds[6].innerText,
            tva: tds[7].innerText,
            ttc: tds[8].innerText,
            validee: tr.classList.contains("validated")
        });
    });

    const ecritures = [];
    document.querySelectorAll("#table-ecritures tbody tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        ecritures.push({
            numPiece: tds[0].innerText,
            journal: tds[1].innerText,
            date: tds[2].innerText,
            fournisseur: tds[3].innerText,
            numFacture: tds[4].innerText,
            compte: tds[5].innerText,
            debit: tds[6].innerText,
            credit: tds[7].innerText
        });
    });

    const data = { factures, ecritures, numeroChrono };
    localStorage.setItem("comptaData", JSON.stringify(data));
}

// Recharge les donn√©es sauvegard√©es depuis le LocalStorage
function chargerDonnees() {
    const data = JSON.parse(localStorage.getItem("comptaData") || "{}");
    if (!data.factures) return;

    numeroChrono = data.numeroChrono || 1;

    const tb = document.querySelector("#table-achats tbody");
    const tE = document.querySelector("#table-ecritures tbody");

    data.factures.forEach(f => {
        const row = tb.insertRow();
        row.insertCell().innerText = f.numPiece;
        row.insertCell().innerText = f.journal;
        row.insertCell().innerText = f.date;
        row.insertCell().innerText = f.fournisseur;
        row.insertCell().innerText = f.numFacture;
        row.insertCell().innerText = f.compte;
        row.insertCell().innerText = f.ht;
        row.insertCell().innerText = f.tva;
        row.insertCell().innerText = f.ttc;

        const cellAct = row.insertCell();
        cellAct.innerHTML = `
            <button class="btn-blue" onclick="modifierFacture(this)" ${f.validee ? "disabled" : ""}>‚úèÔ∏è</button>
            <button class="btn-red" onclick="supprimerFacture(this)" ${f.validee ? "disabled" : ""}>üóëÔ∏è</button>
            <button class="btn-yellow" onclick="validerFacture(this)" ${f.validee ? "disabled" : ""}>‚úîÔ∏è</button>
        `;
        if (f.validee) row.classList.add("validated");
    });

    data.ecritures.forEach(e => {
        const r = tE.insertRow();
        r.insertCell().innerText = e.numPiece;
        r.insertCell().innerText = e.journal;
        r.insertCell().innerText = e.date;
        r.insertCell().innerText = e.fournisseur;
        r.insertCell().innerText = e.numFacture;
        r.insertCell().innerText = e.compte;
        r.insertCell().innerText = e.debit;
        r.insertCell().innerText = e.credit;
    });
}

// Charger les donn√©es d√®s le chargement de la page
window.addEventListener("load", chargerDonnees);
// ============================ EXPORT EXCEL ============================
function exporterExcel() {
    const wb = XLSX.utils.book_new();

    // ======= Onglet Factures =======
    const tableFactures = document.querySelector("#table-achats");
    const wsFactures = XLSX.utils.table_to_sheet(tableFactures);
    XLSX.utils.book_append_sheet(wb, wsFactures, "Factures");

    // ======= Onglet Journal =======
    const tableJournal = document.querySelector("#table-ecritures");
    const wsJournal = XLSX.utils.table_to_sheet(tableJournal);
    XLSX.utils.book_append_sheet(wb, wsJournal, "Journal");

    // ======= T√©l√©chargement du fichier =======
    const nomFichier = "Comptabilite_" + new Date().toISOString().slice(0,10) + ".xlsx";
    XLSX.writeFile(wb, nomFichier);
}
</script>
</body>
</html>
Copyright ¬© MAZZAINE